
alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (

    msg:"CVE-2025-22457 X-Forwarded-For header buffer overflow targeting Ivanti server - Length > 50";

    flow: to_server, established;
    http_header;
    content:"X-Forwarded-For:", fast_pattern, nocase;
    pcre:"/X-Forwarded-For:\s*.{51,}/i";

    classtype:Ivanti_Policy_Secure--CVE-2025-22457;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245701;
    rev:1;
)

# ================================================================

alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (

    msg:"CVE-2025-22457 X-Forwarded-For invalid IPv4 format targeting Ivanti server";

    flow: to_server, established;
    http_header;
    content:"X-Forwarded-For:", fast_pattern, nocase;

    # Detection of invalid IPv4 - uses digits/dots but incorrect format
    # Examples detected: 83298.3232.23424, 999.999.999.999, 256.1.1.1
    # Simplified regex to detect octets > 255 or malformed IPv4
    # Matches patterns like: 256-999.x.x.x or x.256-999.x.x etc.

    pcre:"/X-Forwarded-For:\s*.*?(?:[3-9][0-9]{2}|[0-9]{4,})\.[0-9]/i";

    classtype:HTTP_header_overflow;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245702;
    rev:1;
)

# ================================================================

alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (

    msg:"CVE-2025-22457 X-Forwarded-For invalid IPv6 format targeting Ivanti server";

    flow: to_server, established;
    http_header;
    content:"X-Forwarded-For:", fast_pattern, nocase;

    # Detection of invalid IPv6 - contains non-hex letters in IPv6-like format
    # Examples detected: 2001:xyz1:85a3::1, ghijk:db8::1
    # Simplified regex to detect invalid hex characters in IPv6 format

    pcre:"/X-Forwarded-For:\s*.*?[g-zG-Z][a-zA-Z0-9]*:/i";

    classtype:HTTP_header_overflow;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245708;
    rev:1;
)

# ================================================================

alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (

    msg:"CVE-2025-22457 X-Forwarded-For non-IP content targeting Ivanti server";

    flow: to_server, established;
    http_header;
    content:"X-Forwarded-For:", fast_pattern, nocase;

    # Detection of clearly non-IP content (special characters, non-hex letters)
    # Examples detected: test.example.com, user@domain.com, <script>, {"ip":"test"}
    # Simplified regex to detect obvious non-IP characters

    pcre:"/X-Forwarded-For:\s*.*[g-zG-Z@<>{}\"'=]/i";

    classtype:HTTP_header_overflow;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245709;
    rev:1;
)

# ================================================================

alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (

    msg:"CVE-2025-22457 Heap spray pattern targeting Ivanti server";

    flow: to_server, established;
    http_header;
    content:"X-Forwarded-For:", fast_pattern, nocase;
    pcre:"/X-Forwarded-For:\s*.*?(\d)\1{49,}/i";
   
    classtype:Heap_spray_attack;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245703;
    rev:1;
)

# ================================================================


alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (
    msg:"CVE-2025-22457 Memory address pattern 39393930 targeting Ivanti server";

    flow: to_server, established;
    http_header;
    content:"X-Forwarded-For:", fast_pattern, nocase;
    content:"39393930";
   
    classtype:Ivanti_Policy_Secure--CVE-2025-22457;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245704;
    rev:1;
)